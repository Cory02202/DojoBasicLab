# vi入門
## 1. 本コンテンツの目的とゴール
本コンテンツでは、IBM Developer Dojoのようなクラウドを利用したインフラ構築やアプリケーションデプロイにおいて必要となるコマンド操作の延長として、コマンドラインから利用することのできるテキストエディターであるvi/Vim (* これらの説明は後述) について学ぶことを目的とします。

そのため、viやVimの応用操作などを含めたすべてを網羅するのではなく、一般的によく使われる（と筆者が感じる）操作をベースに、viの基本操作ができるようになるところをゴールとします。

## 2. viとは
viとは、主にUNIX環境で人気のあるテキストエディタです。
Visual EditorまたはVisual Interfaceからその名が付けられたと諸説あります。

viを開発したのは、BSDのBill Joy（William Nelson Joy）で、当初はPascalのソースコードに内包されていたが、後にBill本人により改良が加えられviとして世に認知されたと言われています。

現在よく知られているテキストエディターはスクリーンエディターと呼ばれるものであり、viはラインエディタの文化を受け継いでいるがゆえに操作アプローチが根本的に異なります。例えばWindows標準のメモ帳、Mac標準のテキストエディットなどの一般的なスクリーンエディターと比べるとわかりやすいのですが、以下のような特徴を持ちます。

1. マウスを使わない
2. モードという考え方がある
3. 命令ベースでの操作
4. CUI/CLIベースなので軽量

viの上位互換ツールとしてVimが存在します。MacやLinuxなどのUnix系OSには標準でVimがインストールされていることが多いです。ここでは、Vimとviの詳細な違いについては解説しませんが、Vimではviの機能はほとんど使うことができるので、viの操作を覚えるつもりで読み進めて頂ければと思います。

## 3. エディタのモード
さて、前述の通り、viの特徴の一つにモードという考え方があります。これは、テキストエディタを利用するにあたり、操作のカテゴリで**モード**を切り替えて使いましょう、という考え方です。

モードの利点としては、異なるモードでキー操作が独立するのでより細やかな操作を可能にする、というものがあります。これは、同じく前述の特徴であるマウスを使わないコマンド入力ベースのインターフェースというところからの考え方でしょう。しかしながら、ここではあくまでvi入門ということで、基本的な操作に絞って解説をするため、あまり意識しなくて良いかもしれません。やりたい操作によって、モードを切り替える必要があるんだなぁ、くらいに覚えていただければと思います。

vi/Vimではモードを主に以下の4つに分類します。ただし、厳密にはviでは編集モードとインサートモード（入力モード）の2つであり、4つに分けるのはVimとする考え方もありますが、現在Macではviで起動した場合でも、以下4つのモードを使うことができるので、ここではこのように分類します。

|  モード  |  主な機能  |
| ---- | ---- |
|  ノーマルモード  |  カーソル移動、ヤンク（コピー）、プット（ペースト）、削除  |
|  インサートモード  |  文字入力  |
|  ビジュアルモード  |  範囲選択での編集（ヤンクや削除など）  |
|  コマンドモード  |  保存、終了、検索、置換  |

### 3-1. ノーマルモード
以下に、ノーマルモードで比較的良く使われるコマンドを記します。
ノーマルモードでは、基本的に既存の行や文字列に対しての操作を行うことが主となります。

| キー入力 | 操作 | 
| ---- | ---- |
| [↑] or [k] or [Ctrl]+[p] | カーソル移動（上） |
| [↓] or [j] or [Ctrl]+[n] | カーソル移動（下） |
| [←] or [h] or [BackSpace] | カーソル移動（左） |
| [→] or [l] or [Space] | カーソル移動（右） |
| 数字[↑] or 数字[k] or 数字[Ctrl]+[p] | 指定文字数カーソル移動（上） |
| 数字[↓] or 数字[j] or 数字[Ctrl]+[n] | 指定文字数カーソル移動（下） |
| 数字[←] or 数字[h] or 数字[BackSpace] | 指定文字数カーソル移動（左） |
| 数字[→] or 数字[l] or 数字[Space] | 指定文字数カーソル移動（右） |
| yy | カーソル位置の現在行をヤンク |
| 行数[yy] | カーソル位置の現在行から指定行数分をヤンク |
| dd | カーソルの行を1行削除 |
| 数字[dd] | カーソルの行をn行削除 |
| D | 現在のカーソルから行末まで削除 |
| p | カーソルの後にプット |
| P | カーソルの前にプット |
| c | 削除して入力モードに移行 |
| C | 現在のカーソルから後ろをすべて削除して入力モードに移行 |
| w | 次の単語の先頭に移動 |
| W | 空白と改行で区切られた次の単語の先頭に移動 |
| e | 単語の末尾に移動 |
| E | 空白と改行で区切られた単語の最後尾に移動 |
| b | 前の単語移動 |
| B | 空白と改行で区切られた前の単語に移動 |
| ZZ | 保存してvimを終了する |

### 3-2. インサートモード
以下に、インサートモードで比較的良く使われるキー入力を記します。
インサートモードでは基本的に文字入力を行うことが主となるので、ベタ打ちでの入力でインサートモード、ヤンクなどの編集系コマンドはノーマルモード、といった感じでモードを切り替えながら編集すると良いと思います。

| キー入力 | 操作 | 
| ---- | ---- |
| esc | ノーマルモードに移行 |
| Ctrl-c | ノーマルモードに移行3 |
| Ctrl-y | 上の行のカーソルの位置の文字を挿入 |
| Ctrl-e | 下の行のカーソルの位置の文字を挿入 |
| Ctrl-t | 1タブ入力 |
| Ctrl-d | 1タブ削除 |
| Ctrl-g j | 下の行に移動 |
| Ctrl-g k | 上の行に移動 |
| Ctrl-h | 1文字削除 |
| Ctrl-r {0-9a-z"%#*:=} | 指定したレジスタをプット |
| Ctrl-x Ctrl-n | 開いているファイルないにある単語補完 |

### 3-3. ビジュアルモード
ビジュアルモードは、テキストの部分を選択する柔軟で簡単な方法です。矩形(くけい)範囲のテキスト(ブロック)を選択する唯一の方法でもあります。

| キー入力 | 操作 |
| ---- | ---- |
| - | 大/小文字の切替 |
| y | 選択した範囲をヤンク |
| d | 選択した範囲を削除 |
| c | 選択した範囲を削除して入力モードに移行 |
| > | 右シフト(選択した範囲を1タブ右に移動) |
| < | 左シフト(選択した範囲を1タグ右に移動) |
| I | 矩形選択の時、選択範囲のすべての行先頭にテキストを入力 |
| J | 選択した範囲をすべて連結する |
| o | 選択した範囲の先頭または末尾にカーソルを移動 |

### 3-4. コマンドモード
コマンドモードは、ノーマルモードの状態で：(コロン)をタイプすることでコマンド入力を受け付けます。そのため、移動系の操作はノーマルモードそのものです。

| キー入力 | 操作 |
| ---- | ---- |
| /<文字列> | 文字列検索（順方向） |
| ?<文字列> | 文字列検索（逆方向） |
| n | 順方向へ検索 |
| N | 逆方向へ検索 |
| % | (,[ と対応する ),] などを検索 |
| :s/置換対象文字列/置換後文字列/ | 文字列置換 |
| :s/置換対象文字列/置換後文字列/g | 行置換 |
| :%s/置換対象文字列/置換後文字列/g | ファイル全体置換 |
| new | 新規バッファを作成 |
| tabnew | 新規タブを作成 |
| e | ファイルを編集 |
| r | 入力をバッファに挿入 |
| w | 現在のバッファを開いているファイルに書き込む |
| q | viを終了 |
| wq | バッファをファイルに書き込んでviを終了 |
| q! | viを強制終了 |
| %s/置換対象文字/置換する文字/g | 文字を置換する |
| reg | レジスタ一覧を表示 |
| his | コマンド履歴を表示 |

### 3-5. モード切り替え
以下のように、現在どのモードに居るかを確認の上、モードを切り替えます。

| 現在のモード | 移行先モード | キー |
| ---- | ---- | ---- |
| ノーマル | インサート | i、I、a、A、s、S |
| ノーマル | コマンド | : |
| ノーマル | ビジュアル | v、V、ctr-v |
| インサート | ノーマル | esc、ctrl-c |
| ビジュアル | ノーマル | esc、ctrl-c |
| コマンド | ノーマル | esc、ctrl-c |

## 4. 演習
ここからは、実際にファイルを作成、更新しながらviの操作を覚えていきましょう。繰り返しになりますが、本編ではIBM Developer Dojoなどのワークショップにおいて必要最低限と思われる部分をマスターすることを目的とするので、基礎的な内容であることはご容赦頂けると幸いです。

### 4-1. 起動
1) ターミナルを起動
    Macであればアプリケーションからターミナルを選択し起動します。
    Windowsであれば、UNIXシェル(Bashやzsh)が動作するCUIツールを利用してください。
2) 任意の場所へ作業ディレクトリーを作成
    ディレクトリー名は、ここではworkとしていますが、お好きな名前で置き換えてください。
    ```bash
    $ mkdir work
    $ cd work
    ```

### 4-2. ファイル作成
1) コマンドラインでファイルの新規作成
    **editor-work.txt**という名前でファイルを作成します。以下の通りコマンドを実行してください。
    ```bash
    $ vi editor-work.txt
    ```

    左下に新規でファイルが作成される旨の表示が確認できます。
    ![viでファイルの新規作成](./image/image01.png)

2) 何も編集せずにviを終了
    編集していないのですが、現状はオンメモリ（バッファ）に新規ファイルの情報が存在しているだけになります。コマンドモードで書き込み保存を行い、実ファイルとして保存します。
    vi上で、以下の通りコマンドを実行してください。
    ```vi
    :wq
    ```

    左下に打ち込んだコマンドが表示されればコマンドモードになっています。エディター上へ「:wq」という文字列としてタイプされているような表示になっていると、インサートモードになっている可能性がありますので注意してください。

    以下の画像のような感じに表示されていればOKです。
    ![viで書き込み保存](./image/image02.png)

3) 作成したファイルの確認
    作成した（viコマンドモードで保存した）ファイルが作成されているか確認しましょう。以下のコマンドを実行してください。
    ```bash
    $ ls -l
    -rw-r--r--   1 taiji  staff    0 Jul 27 18:39 editor-work.txt
    ```

    無事、指定したファイル名でファイルが作成されていれば成功です。

### 4-3. ファイル指定
1) viコマンドから特定のファイルを指定して開く
    前の手順で作成した**editor-work.txt**を開きます。以下のコマンドを実行してください。
    ```bash
    $ vi editor-work.txt
    ```

    ４−２の1)と同じコマンドです。異なるのは、先程は未だ存在しないファイル名を指定しており、今回は既存のファイルを指定している、というところです。

    つまり、同じ```vi ファイル名```を実行した場合、存在しないファイル名であれば新規作成としてviエディターが開き、既存のファイル名であればそのファイルを編集する形でviエディターが開く、ということです。

### 4-4. 編集
1) ファイルの中身を編集
    一つ前の手順で、**editor-work.txt**を開いたので、このテキストファイルが編集できる状態でviエディタが開いています。ここでは、開いたファイルの中身が空である事が確認できればOKです。

    ![viでファイルの編集](./image/image03.png)

2) 文字列の書き込み
    インサートモードにして文字列を書き込んでいきましょう。キーの ```i``` を1回タイプしてください。タイプするとインサートモードに入ります。エディタの左下へ[-- INSERT --]という文言が表示されていればインサートモードになっています。

    ![viで文字の書き込み](./image/image04.png)

    何を書き込んでも良いのですが、何か決めたほうがみなさん進めやすいと思うので、以下の文章を書いてみましょう。
    ```vi
    これはテキストエディターです。
    ```

    改行も入れて行きましょうね。通常のメモ帳アプリなんかと同じで、普通にEnterキーを入力すれば改行されます。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。
    ```

    ![viで文字の書き込み](./image/image05.png)

    ここまで入力したら、インサートモードを終了しノーマルモードへ戻りましょう。インサートモードで ```Esc``` キーを1回タイプしてください。タイプするとエディタの左下の[-- INSERT --]という文言が消え、ノーマルモードへ戻ります。

    ![ノーマルモードへ](./image/image06.png)


### 4-5. 保存
1) 編集した内容を保存して閉じる
    これまで入力した内容を保存していきましょう。今度はコマンドモードへ入りましょう。現在はノーマルモードに居ますので、この状態で ```:``` (コロン)を1回タイプしてください

    コロンをタイプすると左下へコマンドを入力できるようになるので、ここで以下の通りコマンドを入れてEnterで実行します。
    ```vi
    wq
    ```

    ![コマンドモードへ](./image/image07.png)

2) 保存したファイルの確認
    コマンドが実行されると、通常のシェルの画面へ戻ります。以下の通りコマンドを実行してファイルのタイムスタンプが更新されていることを確認します。
    ```bash
    $ ls -l
    -rw-r--r--   1 taiji  staff   83 Jul 27 20:52 editor-work.txt
    ```

    さらに、再度 ```vi``` コマンドを実行してファイルの中身が更新されていることを確認します。
    ```bash
    $ vi editor-work.txt
    ```

    ![編集されていることを確認](./image/image08.png)

### 4-6. 破棄
1) ファイルを開く
    一つ前の手順で**editor-work.txt**を ```vi``` で開いている状態です。もし ```:q``` などでエディターを閉じてしまっていたら、再度 ```vi``` で開いてください。

2) 再編集
    追加で編集していきます。既に覚えた通り ```i``` でインサートモードへ移行して、以下のように文章を追加してみましょう。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。
    破棄されることを知りながら文章を追加するテスト。
    ```

    ![破棄文言追加](./image/image09.png)

3) 編集内容を破棄
    先程は、ここで ```:wq``` で編集内容を書き込んで終了、つまり保存して閉じるということをしたわけですが、ここでは編集内容を破棄して閉じるということを行いたいので、保存せずに閉じましょう。

    余談ですが ```:wq``` はwriteしてquiteということなのですが、同じ終了コマンドに ```:q``` がありますね。では、これを実行すれば保存せずに閉じるのでしょうか。 ```:``` コロンを1回タイプしてコマンドモードに移行したら以下の通り入力しEnterで実行してみましょう。
    ```vi
    q
    ```

    ![qコマンド実行](./image/image10.png)

    最後の編集から書き込みしてないよという風に注意されます。よく見ると、オーバーライドするなら ```!``` を追加せよ、とありますね。

    ![qコマンド実行](./image/image11.png)

    ということで以下のようにコマンドを入力し実行します。この注意メッセージが表示された時点でノーマルモードになっていますので、再度コロンをタイプしてコマンドモードへ移行することを忘れないでください。
    ```vi
    q!
    ```

    ![q!コマンド実行](./image/image12.png)

    今度は注意されずに、通常のシェルの画面へ戻ったことが確認できたと思います。再度 ```vi``` コマンドを実行してファイルの中身が更新されて**いない**ことを確認します。
    ```bash
    $ vi editor-work.txt
    ```

    ![編集されていないことを確認](./image/image13.png)

### 4-7. 検索・置換
1) 特定の文字列を検索
    ここでも同じく**editor-work.txt**を使って試していきます。まずはシェルから ```vi``` コマンドで当該ファイルを開きます。
    
    検索を試しやすくするために、少し文字列を増やしていきましょう。好きな文字列を開業しながら追加してください。(日本語でも英語でもOK)
    迷った方は以下の通り追記してください。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。
    apple
    basic
    cobol
    debian
    emacs
    fortran
    ```

    入力を終えたらインサートモードから抜けてノーマルモードに戻っておいてください。
    
    検索や置換はコマンドモードで行いますので、コロンを入力して以下のコマンドを実行してください。
    ```vi
    /apple
    ```

    どうでしょうか？appleの行へカーソルが移動したことが確認できたのではないでしょうか。

    ![検索イメージ](./image/image14.png)

    同じ用に、好きな文字列を指定して、検索できるか試してみてください。

2) 特定の文字列を置換
    こんどは置換していきます。一番基本的な置換は ```s/置換対象文字列/置換後文字列/``` と指定することで実行できます。しかし、この方法は、現在カーソルが当たっている行に対して検索し一番最初にHITした文字列を置換します。ですので、ここではあらかじめ置換したい文字列がある行にカーソルを移動しておいてください。
    
    検索の時と同じようにコロンをタイプしてコマンドモードに入ったら以下のコマンドで置換を行いましょう。
    ```vi
    /s/emacs/vscode/
    ```

    emacsという文字列がvscodeという文字列へ置き換わったのが確認できましたね。
    ![置換結果](./image/image15.png)

    通常は、わざわざ対象行に移動してから置換することは少ないと思います。だいたいのケースにおいては、ファイル全体に対して置換をかけに行くのではないでしょうか。その場合は ```:%s/置換対象文字列/置換後文字列/g``` でコマンドを実行していきます。

    では、以下の通りコマンドを実行してください。コマンド実行前にコロンを忘れないようにしてくださいね。
    今回はカーソルはどこにあっても大丈夫です。
    ```vi
    %s/apple/windows/g
    ```

    appleという文字列がwindowsという文字列へ置き換わったのが確認できましたね。
    ![置換結果](./image/image16.png)

### 4-8. ヤンク(コピー)・プット(ペースト)
1) 指定した行をヤンク・プット
    引き続き**editor-work.txt**を使って試していきます。
    ノーマルモードで、カーソルを任意の行のどこか(どこでも大丈夫です)に合わせ、```y```、```y``` と入力してください。ここでは、**wndows**の行にカーソルをあわせて```y```を2回タイプします。これで1行ヤンクされた状態です。つまりバッファに保存された状態で、WindowsやMacで言えばクリップボードに保存されたことと同義です。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。
    windows
    basic
    cobol
    debian
    vscode
    fortran
    ```

    次に、```p```を1回タイプします。**windows**の行が一行追加され、2行になったのが確認できると思います。これがプットで、WindowsやMacで言うところのペーストにあたります。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。
    windows
    windows
    basic
    cobol
    debian
    vscode
    fortran
    ```

    次に、一気に複数行複製したい場合です。さきほどの状態のまま```数字```＋```p```を実行してみましょう。```2```、```p```と入力してください。先ほどヤンクしたバッファが残っているので、もう2行プットされたことが確認できたと思います。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。
    windows
    windows
    windows
    windows
    basic
    cobol
    debian
    vscode
    fortran
    ```

    では、複数行をヤンクしたい場合どうすればよいでしょうか。例えば7行目から9行目をコピーしたい場合は7行目にあわせて```3```、```y```、```y```としてみましょう。その後カーソルを任意の場所へ合わせ```p```をタイプすると**カーソル行の下**にプットされ、指定した3行が複製できます。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。
    windows
    windows
    windows
    windows
    basic
    cobol
    debian
    vscode
    fortran
    ```

2) 指定した文字をヤンク・プット
    ノーマルモードで、カーソルを任意の単語のどこかへ(どこでも大丈夫です)に合わせ、```yw```をタイプすると、カーソルが当たっている単語を広いヤンクされます。その後のプットはカーソルの当たっている場所の後ろへプットされます。

    例えばここでは、2行目の先頭でヤンクしてみます。そうすると、**普通**という単語がヤンクされます。同じ行の最後尾の```。```で```p```をタイプすると、一番うしろへ**普通**が追記されます。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。普通
    windows
    windows
    windows
    windows
    basic
    cobol
    debian
    vscode
    fortran
    ```

3) マウス使うパターン
    ここまでは、セオリー通りマウスを使わずにキータイプだけで操作するという形で説明をしました。もともとがそういった思想のエディターなので、まずはこれらのヤンク、プットを覚えて頂けたらと思います。

    しかし、現在ではほとんどの端末でマウス操作ができるというのが現状ですので、実は普通にCtl+c/vやCmd+c/vでコピーペーストができたりします。マウスで範囲選択して、一般的なテキストエディターを操作する感じでコピーペーストしてみてください。普通にできたのではないでしょうか。ただし、マウスで選択した部分をコピーしても、ペーストされるのはviのカーソルがある部分を軸になされるので注意が必要です。

### 4-9. Undo、Redo
1) 直前の操作の取り消し
    これは簡単です。直前の操作を取り消したいタイミングでコマンドモードに移行し次のコマンドを実行するだけです。
     ```vi
    undo
    ```

    では、操作取り消しを試すために、最終行をヤンク、プットしてください。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。普通
    windows
    windows
    windows
    windows
    basic
    cobol
    debian
    vscode
    fortran
    fortran
    ```

    そうしたら、コマンドモードで```undo```とタイプしてください。最終行へ追加された(プットされた)**fortran**が取り消されたと思います。これが取り消し=Undoになります。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。普通
    windows
    windows
    windows
    windows
    basic
    cobol
    debian
    vscode
    fortran
    ```

2) 取り消しの取り消し
    もうおわかりですね、コマンドモードで以下のコマンドを実行してください。
     ```vi
    redo
    ```
    では、試してみましょう。先程Undoした状態で、コマンドモードに移行し```redo```を実行してください。fortranが復活したとおもいます。これが取り消し=Redoになります。
    ```vi
    これはテキストエディターです。
    普通に改行もできますよ。普通
    windows
    windows
    windows
    windows
    basic
    cobol
    debian
    vscode
    fortran
    fortran
    ```

## 5. まとめ
いかがでしたでしょうか。少しでもviを使うことへの心理的ハードルが低くなってくれたのでしたら、本演習は成功かなと思います。

冒頭で書いたとおり、今回はvi/Vimの全てではなく、ごくごく基本的な操作に焦点を合わせて演習を行いました。これは、IBM Developer DojoではCLIの操作を行うことも少なくなく、基本的なvi操作についても知っていると便利であろうとのことからです。

コンテンツ内容は注意して作成しているつもりではありますが、お気づきの点や間違っている内容のご指摘等がありましたら、Issueを上げていただけますと助かります。